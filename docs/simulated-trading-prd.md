# 模拟交易系统 PRD

> 记录模拟买卖操作，追踪收益表现，验证选股能力

---

## 一、项目背景

### 1.1 需求场景

用户在分析K线形态后，想要：
1. 记录"如果我买了这只股票"的模拟操作
2. 追踪模拟持仓的收益表现
3. 对比自己的选股收益 vs 大盘
4. 验证自己的选股能力和判断准确率

### 1.2 股票池层级关系

```
全市场 (5000+只)
    ↓ 筛选
热门概念 (按概念板块分类)
    ↓ 关注
自选股 (Watchlist监控)
    ↓ 看好并买入
模拟持仓 (最小池，实际"下注"的股票)
```

---

## 二、核心功能

### 2.1 模拟买入

**触发方式**：
1. 自选股卡片上的"模拟买入"按钮
2. K线评分 >= 8分时自动提示（如已持仓则不提示）

**买入流程**：
```
触发买入
    ↓
显示买入对话框
    ├── 当前价格: ¥1,580 (可修改)
    ├── 买入仓位: [10%] [20%] [30%] [50%] [自定义]
    ├── 可用资金: ¥700万 (剩余现金)
    ├── 买入金额: ¥200万 (自动计算)
    └── 备注: [输入框] (如：双底突破回踩)
    ↓
确认买入
    ↓
记录交易，更新持仓
```

**仓位规则**：
- 仓位百分比基于**剩余现金**计算
- 最大仓位限制：不能超过100%总仓位（即不能加杠杆）
- 买入金额 = 剩余现金 × 仓位百分比

### 2.2 模拟卖出

**触发方式**：
1. 自选股卡片上的"卖出"按钮（已持仓时显示）
2. 模拟组合页面的"卖出"按钮

**卖出流程**：
```
触发卖出
    ↓
显示卖出对话框
    ├── 当前价格: ¥1,650 (可修改)
    ├── 持仓数量: 1,899股 (¥300万)
    ├── 卖出比例: [25%] [50%] [100%] [自定义]
    ├── 卖出金额: ¥300万 (自动计算)
    ├── 盈亏: +¥70,000 (+4.4%)
    └── 备注: [输入框] (如：止盈)
    ↓
确认卖出
    ↓
记录交易，更新持仓，现金回笼
```

**部分卖出**：
- 支持卖出持仓的一部分（如持有50%仓位，卖出20%，保留30%）
- 部分卖出后，剩余持仓的成本价保持不变

### 2.3 模拟组合页面

**入口**：顶部导航新增"模拟组合"Tab

**页面结构**：
```
┌─────────────────────────────────────────────────────────────┐
│  模拟组合                                                    │
│  初始资金: ¥1,000万    当前市值: ¥1,085万    总收益: +8.5%   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  资金概览                                                    │
│  ├── 持仓市值: ¥750万 (75%)                                 │
│  ├── 可用现金: ¥250万 (25%)                                 │
│  └── 总资产: ¥1,000万 → ¥1,085万                           │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  当前持仓 (3只)                                              │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ 股票       仓位    成本价   现价    持仓市值  盈亏   操作 ││
│  │ 贵州茅台   30%    ¥1,580  ¥1,650  ¥330万  +4.4%  [卖出]││
│  │ 宁德时代   30%    ¥210    ¥235    ¥335万  +11.9% [卖出]││
│  │ 比亚迪     15%    ¥280    ¥275    ¥147万  -1.8%  [卖出]││
│  └─────────────────────────────────────────────────────────┘│
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  收益对比                                                    │
│  ├── 我的组合: +8.5%                                        │
│  ├── 沪深300: +2.1%                                         │
│  ├── 自选股平均: +3.2%                                      │
│  └── 超额收益: +6.4% ✓                                      │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  交易历史                                        [查看全部 >]│
│  ┌─────────────────────────────────────────────────────────┐│
│  │ 01-15 贵州茅台 卖出 ¥1,650 全部(¥330万) 止盈+4.4%       ││
│  │ 01-12 宁德时代 买入 ¥210   30%(¥300万)  MACD金叉        ││
│  │ 01-10 贵州茅台 买入 ¥1,580 30%(¥300万)  双底突破        ││
│  │ ...                                                     ││
│  └─────────────────────────────────────────────────────────┘│
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.4 交易历史

**记录内容**：
| 字段 | 说明 |
|-----|------|
| 日期 | 交易日期 |
| 股票 | 股票代码和名称 |
| 操作 | 买入 / 卖出 |
| 价格 | 成交价格 |
| 数量/金额 | 交易股数和金额 |
| 仓位变化 | 如：30% → 0% |
| 盈亏 | 卖出时显示盈亏金额和百分比 |
| 备注 | 用户填写的交易理由 |

### 2.5 评分联动

**触发条件**：K线评分 >= 8分 且 该股票当前未持仓

**交互流程**：
```
提交评分 (>=8分)
    ↓
弹出提示: "评分8分，是否模拟买入？"
    ├── [是] → 显示买入对话框
    └── [否] → 关闭提示
```

---

## 三、数据模型

### 3.1 模拟账户 (SimulatedAccount)

```sql
CREATE TABLE simulated_account (
    id INTEGER PRIMARY KEY,
    initial_capital DECIMAL(15,2) DEFAULT 10000000,  -- 初始资金，默认1000万
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.2 模拟交易记录 (SimulatedTrade)

```sql
CREATE TABLE simulated_trade (
    id INTEGER PRIMARY KEY,
    ticker VARCHAR(10) NOT NULL,           -- 股票代码
    stock_name VARCHAR(50),                -- 股票名称
    trade_type VARCHAR(10) NOT NULL,       -- 'buy' 或 'sell'
    trade_date DATE NOT NULL,              -- 交易日期
    trade_price DECIMAL(10,2) NOT NULL,    -- 成交价格
    shares INTEGER NOT NULL,               -- 交易股数
    amount DECIMAL(15,2) NOT NULL,         -- 交易金额
    position_pct DECIMAL(5,2),             -- 仓位百分比（买入时）
    note TEXT,                             -- 备注
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- 卖出时的盈亏信息
    realized_pnl DECIMAL(15,2),            -- 实现盈亏金额
    realized_pnl_pct DECIMAL(5,2)          -- 实现盈亏百分比
);
```

### 3.3 当前持仓 (SimulatedPosition)

```sql
CREATE TABLE simulated_position (
    id INTEGER PRIMARY KEY,
    ticker VARCHAR(10) NOT NULL UNIQUE,    -- 股票代码
    stock_name VARCHAR(50),                -- 股票名称
    shares INTEGER NOT NULL,               -- 持仓股数
    cost_price DECIMAL(10,2) NOT NULL,     -- 成本价（加权平均）
    cost_amount DECIMAL(15,2) NOT NULL,    -- 成本金额
    first_buy_date DATE NOT NULL,          -- 首次买入日期
    last_trade_date DATE NOT NULL,         -- 最后交易日期
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

## 四、API 设计

### 4.1 获取账户概览

```
GET /api/simulated/account

Response:
{
    "initial_capital": 10000000,
    "cash": 2500000,
    "position_value": 7500000,
    "total_value": 10000000,
    "total_pnl": 850000,
    "total_pnl_pct": 8.5,
    "position_count": 3
}
```

### 4.2 获取当前持仓

```
GET /api/simulated/positions

Response:
{
    "positions": [
        {
            "ticker": "600519",
            "stock_name": "贵州茅台",
            "shares": 1899,
            "cost_price": 1580.00,
            "cost_amount": 3000000,
            "current_price": 1650.00,
            "current_value": 3133350,
            "pnl": 133350,
            "pnl_pct": 4.44,
            "position_pct": 30.0,
            "first_buy_date": "2026-01-10",
            "holding_days": 5
        },
        ...
    ]
}
```

### 4.3 模拟买入

```
POST /api/simulated/buy

Request:
{
    "ticker": "600519",
    "price": 1580.00,
    "position_pct": 30,      // 仓位百分比（基于剩余现金）
    "note": "双底突破回踩"
}

Response:
{
    "success": true,
    "trade_id": 1,
    "shares": 1899,
    "amount": 3000000,
    "message": "买入成功：贵州茅台 1899股，成交价¥1,580"
}
```

### 4.4 模拟卖出

```
POST /api/simulated/sell

Request:
{
    "ticker": "600519",
    "price": 1650.00,
    "sell_pct": 100,         // 卖出比例（基于持仓）
    "note": "止盈"
}

Response:
{
    "success": true,
    "trade_id": 2,
    "shares": 1899,
    "amount": 3133350,
    "pnl": 133350,
    "pnl_pct": 4.44,
    "message": "卖出成功：贵州茅台 1899股，盈利¥133,350 (+4.44%)"
}
```

### 4.5 获取交易历史

```
GET /api/simulated/trades?limit=50&offset=0

Response:
{
    "trades": [
        {
            "id": 2,
            "ticker": "600519",
            "stock_name": "贵州茅台",
            "trade_type": "sell",
            "trade_date": "2026-01-15",
            "trade_price": 1650.00,
            "shares": 1899,
            "amount": 3133350,
            "realized_pnl": 133350,
            "realized_pnl_pct": 4.44,
            "note": "止盈",
            "created_at": "2026-01-15T10:30:00"
        },
        ...
    ],
    "total": 10
}
```

### 4.6 检查是否持仓

```
GET /api/simulated/check/{ticker}

Response:
{
    "has_position": true,
    "position": {
        "shares": 1899,
        "cost_price": 1580.00,
        "pnl_pct": 4.44
    }
}
```

### 4.7 获取收益对比

```
GET /api/simulated/performance?days=30

Response:
{
    "period": "30d",
    "my_return": 8.5,
    "benchmark": {
        "hs300": 2.1,
        "watchlist_avg": 3.2
    },
    "excess_return": 6.4,
    "win_rate": 66.7,           // 盈利股票占比
    "avg_holding_days": 5.2
}
```

---

## 五、前端界面

### 5.1 自选股卡片改动

在 `WatchlistCard` 底部添加买入/卖出按钮：

```
┌─────────────────────────────────────────────────────────┐
│  [K线图]                                                │
├─────────────────────────────────────────────────────────┤
│  [描述框] [评分] [提交标注]                              │
├─────────────────────────────────────────────────────────┤
│  未持仓:  [模拟买入]                                     │
│  已持仓:  持仓30% +4.4%  [加仓] [卖出]                   │
└─────────────────────────────────────────────────────────┘
```

### 5.2 买入对话框

```
┌─────────────────────────────────────────┐
│  模拟买入 - 贵州茅台 (600519)           │
├─────────────────────────────────────────┤
│                                         │
│  当前价格                               │
│  ┌─────────────────────────────────┐   │
│  │ ¥ 1,580.00              [修改]  │   │
│  └─────────────────────────────────┘   │
│                                         │
│  买入仓位 (可用现金: ¥700万)            │
│  [10%] [20%] [30%] [50%] [___]%        │
│                                         │
│  买入金额: ¥210万                       │
│  预计股数: 1,329股                      │
│                                         │
│  备注                                   │
│  ┌─────────────────────────────────┐   │
│  │ 双底突破回踩，评分8分            │   │
│  └─────────────────────────────────┘   │
│                                         │
│           [取消]  [确认买入]            │
└─────────────────────────────────────────┘
```

### 5.3 顶部导航

```
[自选股] [热门概念] [全市场] [模拟组合]
                              ↑ 新增
```

---

## 六、开发任务

### 6.1 后端

- [ ] 创建数据模型 (`src/models.py`)
  - [ ] SimulatedAccount
  - [ ] SimulatedTrade
  - [ ] SimulatedPosition

- [ ] 创建 API 路由 (`src/api/routes_simulated.py`)
  - [ ] GET /api/simulated/account
  - [ ] GET /api/simulated/positions
  - [ ] POST /api/simulated/buy
  - [ ] POST /api/simulated/sell
  - [ ] GET /api/simulated/trades
  - [ ] GET /api/simulated/check/{ticker}
  - [ ] GET /api/simulated/performance

- [ ] 创建服务层 (`src/services/simulated_service.py`)
  - [ ] 买入逻辑（计算股数、更新持仓、扣减现金）
  - [ ] 卖出逻辑（计算盈亏、更新持仓、回笼现金）
  - [ ] 收益计算（获取实时价格、计算市值）

### 6.2 前端

- [ ] 创建模拟组合页面 (`SimulatedPortfolioPage.tsx`)
  - [ ] 账户概览卡片
  - [ ] 持仓列表
  - [ ] 收益对比
  - [ ] 交易历史

- [ ] 创建交易对话框组件
  - [ ] `BuyDialog.tsx` - 买入对话框
  - [ ] `SellDialog.tsx` - 卖出对话框

- [ ] 修改 `WatchlistCard.tsx`
  - [ ] 添加买入/卖出按钮
  - [ ] 显示持仓状态

- [ ] 修改 `KlineEvaluationForm.tsx`
  - [ ] 评分>=8分时触发买入提示

- [ ] 修改顶部导航
  - [ ] 添加"模拟组合"Tab

---

## 七、注意事项

### 7.1 价格获取

- 买入/卖出时默认使用实时价格
- 计算持仓市值时需要获取最新价格
- 非交易时间使用最近收盘价

### 7.2 边界情况

- 可用现金不足时，提示"资金不足"
- 卖出数量超过持仓时，提示错误
- 同一股票多次买入时，成本价用加权平均计算

### 7.3 数据一致性

- 买入/卖出操作需要事务保证
- Position 表和 Trade 表需要同步更新

---

**文档版本**: v1.0
**创建日期**: 2026-01-10
**最后更新**: 2026-01-10
