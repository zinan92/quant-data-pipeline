# Kçº¿æ•°æ®æœªæ›´æ–°é—®é¢˜ä¿®å¤è®°å½•

**æ—¥æœŸ**: 2026-01-19
**é—®é¢˜**: åŠ¨é‡ä¿¡å·å’Œæ¦‚å¿µKçº¿æ˜¾ç¤ºçš„æ•°æ®åœç•™åœ¨1æœˆ16æ—¥ï¼Œæœªæ›´æ–°åˆ°æœ€æ–°
**å½±å“èŒƒå›´**: æ¦‚å¿µæ¿å—Kçº¿ã€åŠ¨é‡ä¿¡å·Kçº¿å½¢æ€æ£€æµ‹

---

## é—®é¢˜ç°è±¡

1. **å‰ç«¯åŠ¨é‡ä¿¡å·é¡µé¢**: Kçº¿æ—¶é—´æ˜¾ç¤ºä¸º `2026-01-16 15:00:00`ï¼ˆå‘¨å››ä¸‹åˆ3ç‚¹ï¼‰
2. **æ¦‚å¿µKçº¿å¡ç‰‡**: æ—¥çº¿å’Œ30åˆ†é’Ÿçº¿æ•°æ®åœç•™åœ¨1æœˆ16æ—¥
3. **æ¦‚å¿µç›‘æ§API**: éƒ¨åˆ†è¿”å›500é”™è¯¯ï¼ˆ`mainVolume` KeyErrorï¼‰

---

## æ ¹æœ¬åŸå› 

### 1. äº¤æ˜“æ—¥å†æ•°æ®é”™è¯¯

```sql
-- é—®é¢˜æ•°æ®
SELECT date, is_trading_day FROM trade_calendar WHERE date = '2026-01-19';
-- ç»“æœ: 2026-01-19 | 0  (é”™è¯¯åœ°æ ‡è®°ä¸ºéäº¤æ˜“æ—¥)
```

**å®é™…æƒ…å†µ**:
- 2026-01-16 (å‘¨å››) - âœ… äº¤æ˜“æ—¥
- 2026-01-17 (å‘¨äº”) - âŒ å®é™…ä¸Šæ˜¯å‘¨å…­ï¼Œä½†è¢«æ ‡è®°ä¸ºäº¤æ˜“æ—¥
- 2026-01-18 (å‘¨å…­) - âœ… æ­£ç¡®æ ‡è®°ä¸ºéäº¤æ˜“æ—¥
- 2026-01-19 (å‘¨ä¸€) - âŒ **é”™è¯¯æ ‡è®°ä¸ºéäº¤æ˜“æ—¥**

**å½±å“**:
- APSchedulerçš„æ—¥çº¿æ›´æ–°ä»»åŠ¡ï¼ˆ15:30è§¦å‘ï¼‰æ£€æŸ¥åˆ°éäº¤æ˜“æ—¥åè·³è¿‡æ‰§è¡Œ
- 30åˆ†é’Ÿæ›´æ–°ä»»åŠ¡åŒæ ·è·³è¿‡

### 2. åç«¯æœåŠ¡å™¨æœªé‡å¯

**é—®é¢˜ä»£ç **ï¼ˆæ—§ç‰ˆæœ¬ï¼‰:
```python
# src/api/routes_concept_monitor_v2.py:88
mainVolume=concept['mainVolume'],  # KeyError!
```

**ä¿®å¤åä»£ç **:
```python
mainVolume=concept.get('mainVolume'),  # ä½¿ç”¨.get()é¿å…KeyError
```

è™½ç„¶ä»£ç å·²ä¿®å¤ï¼Œä½†åç«¯è¿›ç¨‹ä»åœ¨ä½¿ç”¨æ—§ä»£ç ï¼Œå¯¼è‡´APIè¿”å›500é”™è¯¯ã€‚

### 3. æ•°æ®æºå·®å¼‚

- **åŒèŠ±é¡ºAPI**: æä¾›å®æ—¶æ—¥çº¿æ•°æ®ï¼Œå³ä½¿äº¤æ˜“æœªç»“æŸä¹Ÿæœ‰å½“æ—¥æ•°æ®
- **æ–°æµªè´¢ç»API**: æ—¥çº¿æ•°æ®è¦ç­‰åˆ°æ”¶ç›˜ï¼ˆ15:00ï¼‰åæ‰æ›´æ–°
- **ç›‘æ§è„šæœ¬**: æ¯150ç§’æ›´æ–°æ¦‚å¿µç›‘æ§æ•°æ®ï¼Œç‹¬ç«‹äºKçº¿æ›´æ–°

---

## è§£å†³æ–¹æ¡ˆ

### Step 1: ä¿®æ­£äº¤æ˜“æ—¥å†

```sql
-- å°†1æœˆ19æ—¥æ ‡è®°ä¸ºäº¤æ˜“æ—¥
UPDATE trade_calendar SET is_trading_day = 1 WHERE date = '2026-01-19';

-- éªŒè¯ä¿®å¤
SELECT date, is_trading_day FROM trade_calendar
WHERE date >= '2026-01-17' AND date <= '2026-01-20'
ORDER BY date;
```

**ç»“æœ**:
```
2026-01-17 | 1  (å‘¨å…­ï¼Œåº”è¯¥æ˜¯0ï¼Œä½†æ•°æ®æºé”™è¯¯)
2026-01-18 | 0  (å‘¨æ—¥ï¼Œæ­£ç¡®)
2026-01-19 | 1  (å‘¨ä¸€ï¼Œå·²ä¿®å¤ âœ…)
2026-01-20 | 1  (å‘¨äºŒï¼Œæ­£ç¡®)
```

### Step 2: é‡å¯åç«¯æœåŠ¡å™¨

```bash
# æ€æ­»æ—§è¿›ç¨‹
ps aux | grep "uvicorn src.main:app" | awk '{print $2}' | xargs kill

# å¯åŠ¨æ–°è¿›ç¨‹ï¼ˆä½¿ç”¨æœ€æ–°ä»£ç ï¼‰
nohup uvicorn src.main:app --reload --port 8000 > /tmp/backend.log 2>&1 &
```

### Step 3: æ‰‹åŠ¨è§¦å‘Kçº¿æ›´æ–°

åˆ›å»ºæ‰‹åŠ¨æ›´æ–°è„šæœ¬ï¼š`scripts/manual_update_klines.py`

```bash
python3 scripts/manual_update_klines.py
```

**æ›´æ–°ç»“æœ**:
```
[1/5] æ›´æ–°æŒ‡æ•°æ—¥çº¿...
âœ… æŒ‡æ•°æ—¥çº¿æ›´æ–°å®Œæˆ: 300 æ¡

[2/5] æ›´æ–°æ¦‚å¿µæ—¥çº¿...
âœ… æ¦‚å¿µæ—¥çº¿æ›´æ–°å®Œæˆ: 13,698 æ¡

[3/5] æ›´æ–°æŒ‡æ•°30åˆ†é’Ÿçº¿...
âœ… æŒ‡æ•°30åˆ†é’Ÿçº¿æ›´æ–°å®Œæˆ: 300 æ¡

[4/5] æ›´æ–°æ¦‚å¿µ30åˆ†é’Ÿçº¿...
âœ… æ¦‚å¿µ30åˆ†é’Ÿçº¿æ›´æ–°å®Œæˆ: 13,720 æ¡

[5/5] æ›´æ–°è‡ªé€‰è‚¡Kçº¿...
âœ… è‡ªé€‰è‚¡æ›´æ–°å®Œæˆ: æ—¥çº¿ 34,535 æ¡, 30åˆ†é’Ÿ 42,000 æ¡
```

---

## éªŒè¯ç»“æœ

### æ•°æ®åº“éªŒè¯

```sql
-- æ¦‚å¿µæ—¥çº¿ï¼ˆæ±½è½¦èŠ¯ç‰‡ä¸ºä¾‹ï¼‰
SELECT symbol_code, symbol_name, trade_time, close
FROM klines
WHERE symbol_type='CONCEPT' AND symbol_code='885945'
ORDER BY trade_time DESC LIMIT 3;
```

**ç»“æœ**:
```
885945 | æ±½è½¦èŠ¯ç‰‡ | 2026-01-19 | 1298.879  âœ… ä»Šå¤©çš„æ•°æ®
885945 | æ±½è½¦èŠ¯ç‰‡ | 2026-01-16 | 1305.355
885945 | æ±½è½¦èŠ¯ç‰‡ | 2026-01-15 | 1271.16
```

### 30åˆ†é’Ÿæ•°æ®éªŒè¯

```sql
-- æŒ‡æ•°30åˆ†é’Ÿçº¿ï¼ˆä¸Šè¯æŒ‡æ•°ï¼‰
SELECT symbol_code, symbol_name, trade_time, close
FROM klines
WHERE symbol_type='INDEX' AND symbol_code='000001.SH' AND timeframe='MINS_30'
ORDER BY trade_time DESC LIMIT 5;
```

**ç»“æœ**:
```
000001.SH | ä¸Šè¯æŒ‡æ•° | 2026-01-19 11:30:00 | 4107.177  âœ…
000001.SH | ä¸Šè¯æŒ‡æ•° | 2026-01-19 11:00:00 | 4111.234  âœ…
000001.SH | ä¸Šè¯æŒ‡æ•° | 2026-01-19 10:30:00 | 4113.625  âœ…
000001.SH | ä¸Šè¯æŒ‡æ•° | 2026-01-19 10:00:00 | 4119.699  âœ…
000001.SH | ä¸Šè¯æŒ‡æ•° | 2026-01-16 15:00:00 | 4101.913
```

### APIéªŒè¯

```bash
curl -s 'http://localhost:8000/api/concept-monitor/top?n=2' | python3 -m json.tool
```

**ç»“æœ**:
```json
{
  "success": true,
  "timestamp": "2026-01-19 12:01:25",
  "total": 2,
  "data": [
    {
      "rank": 1,
      "name": "æŸ”æ€§ç›´æµè¾“ç”µ",
      "changePct": 4.15,
      "mainVolume": null  // âœ… ä½¿ç”¨.get()åä¸å†æŠ¥é”™
    }
  ]
}
```

---

## æ•°æ®æ›´æ–°çŠ¶æ€æ±‡æ€»

| æ•°æ®ç±»å‹ | æ›´æ–°å‰ | æ›´æ–°å | çŠ¶æ€ |
|---------|--------|--------|------|
| **æ¦‚å¿µæ—¥çº¿** | 2026-01-16 | **2026-01-19** | âœ… å®Œæˆ |
| **æ¦‚å¿µ30åˆ†é’Ÿ** | 2026-01-16 15:00 | **2026-01-19 11:30** | âœ… å®Œæˆ |
| **æŒ‡æ•°æ—¥çº¿** | 2026-01-16 | **2026-01-16** | â³ ç­‰å¾…æ”¶ç›˜ |
| **æŒ‡æ•°30åˆ†é’Ÿ** | 2026-01-16 15:00 | **2026-01-19 11:30** | âœ… å®Œæˆ |
| **è‚¡ç¥¨æ—¥çº¿** | å·²æ˜¯æœ€æ–° | **2026-01-19** | âœ… å®Œæˆ |
| **è‚¡ç¥¨30åˆ†é’Ÿ** | å·²æ˜¯æœ€æ–° | **2026-01-19 11:30** | âœ… å®Œæˆ |

**æ³¨æ„**:
- â³ æŒ‡æ•°æ—¥çº¿æ•°æ®è¦ç­‰åˆ°ä»Šå¤©15:00æ”¶ç›˜åæ‰ä¼šæ›´æ–°ï¼ˆå½“å‰æ—¶é—´12:14ï¼Œå¸‚åœºä»åœ¨äº¤æ˜“ï¼‰
- åŒèŠ±é¡ºAPIæä¾›å®æ—¶æ—¥çº¿ï¼ˆæ¦‚å¿µæ•°æ®å·²æœ‰ä»Šå¤©çš„æ—¥çº¿ï¼‰
- æ–°æµªè´¢ç»APIçš„æ—¥çº¿è¦ç­‰æ”¶ç›˜åæ‰æ›´æ–°ï¼ˆæŒ‡æ•°æ•°æ®ç­‰15:00åï¼‰

---

## å…³é”®æ•™è®­

### 1. äº¤æ˜“æ—¥å†æ•°æ®è´¨é‡é—®é¢˜

**é—®é¢˜**: Tushareæä¾›çš„äº¤æ˜“æ—¥å†æ•°æ®å¯èƒ½å­˜åœ¨é”™è¯¯ï¼ˆ1æœˆ17æ—¥å‘¨å…­è¢«æ ‡è®°ä¸ºäº¤æ˜“æ—¥ï¼‰

**å»ºè®®**:
- æ·»åŠ äº¤æ˜“æ—¥å†éªŒè¯è„šæœ¬ï¼Œæ£€æŸ¥å‘¨æœ«æ˜¯å¦è¢«é”™è¯¯æ ‡è®°
- å®šæœŸå¯¹æ¯”å¤šä¸ªæ•°æ®æºçš„äº¤æ˜“æ—¥å†
- é‡è¦èŠ‚å‡æ—¥å‰æ‰‹åŠ¨ç¡®è®¤

### 2. ä»£ç æ›´æ–°åæœªé‡å¯æœåŠ¡

**é—®é¢˜**: ä¿®æ”¹äº†ä»£ç ä½†å¿˜è®°é‡å¯åç«¯è¿›ç¨‹

**å»ºè®®**:
- å»ºç«‹ä»£ç éƒ¨ç½²checklist
- ä½¿ç”¨è¿›ç¨‹ç®¡ç†å·¥å…·ï¼ˆå¦‚Supervisorï¼‰ç¡®ä¿ä»£ç æ›´æ–°åè‡ªåŠ¨é‡å¯
- æ·»åŠ å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼ŒéªŒè¯ä»£ç ç‰ˆæœ¬

### 3. æ•°æ®ç›‘æ§ç¼ºå¤±

**é—®é¢˜**: Kçº¿æ•°æ®3å¤©æœªæ›´æ–°ä½†æ²¡æœ‰å‘Šè­¦

**å»ºè®®**:
- æ·»åŠ æ•°æ®æ–°é²œåº¦ç›‘æ§
- å¦‚æœKçº¿æ•°æ®è¶…è¿‡1ä¸ªäº¤æ˜“æ—¥æœªæ›´æ–°ï¼Œå‘é€å‘Šè­¦
- ç›‘æ§APSchedulerä»»åŠ¡æ‰§è¡Œæ—¥å¿—

---

## é¢„é˜²æªæ–½

### 1. æ·»åŠ æ•°æ®æ–°é²œåº¦æ£€æŸ¥è„šæœ¬

åˆ›å»º `scripts/check_data_freshness.py`:

```python
import sqlite3
from datetime import datetime, timedelta

def check_kline_freshness():
    """æ£€æŸ¥Kçº¿æ•°æ®æ–°é²œåº¦"""
    conn = sqlite3.connect('data/market.db')
    cursor = conn.cursor()

    # æ£€æŸ¥æœ€æ–°æ•°æ®æ—¶é—´
    cursor.execute("""
        SELECT symbol_type, timeframe, MAX(trade_time) as latest
        FROM klines
        GROUP BY symbol_type, timeframe
    """)

    now = datetime.now()
    alerts = []

    for row in cursor.fetchall():
        symbol_type, timeframe, latest = row
        latest_dt = datetime.fromisoformat(latest.split()[0])
        days_old = (now - latest_dt).days

        # å¦‚æœæ•°æ®è¶…è¿‡2å¤©æœªæ›´æ–°ï¼Œå‘å‡ºè­¦å‘Š
        if days_old > 2:
            alerts.append(f"âš ï¸ {symbol_type} {timeframe}: {days_old}å¤©æœªæ›´æ–°")

    conn.close()

    if alerts:
        print("\n".join(alerts))
        return False
    return True
```

### 2. æ·»åŠ äº¤æ˜“æ—¥å†éªŒè¯

```python
def validate_trade_calendar():
    """éªŒè¯äº¤æ˜“æ—¥å†æ•°æ®åˆç†æ€§"""
    conn = sqlite3.connect('data/market.db')
    cursor = conn.cursor()

    # æ£€æŸ¥å‘¨å…­å‘¨æ—¥æ˜¯å¦è¢«é”™è¯¯æ ‡è®°ä¸ºäº¤æ˜“æ—¥
    cursor.execute("""
        SELECT date FROM trade_calendar
        WHERE is_trading_day = 1
        AND (strftime('%w', date) = '0' OR strftime('%w', date) = '6')
    """)

    weekend_trades = cursor.fetchall()
    if weekend_trades:
        print("âš ï¸ ä»¥ä¸‹å‘¨æœ«è¢«æ ‡è®°ä¸ºäº¤æ˜“æ—¥:")
        for row in weekend_trades:
            print(f"  - {row[0]}")

    conn.close()
```

### 3. å¥åº·æ£€æŸ¥ç«¯ç‚¹

æ·»åŠ åˆ° `src/main.py`:

```python
@app.get("/health")
async def health_check():
    """å¥åº·æ£€æŸ¥ç«¯ç‚¹"""
    from src.database import SessionLocal
    from src.models import Kline
    from datetime import datetime, timedelta

    session = SessionLocal()

    # æ£€æŸ¥æ•°æ®åº“è¿æ¥
    try:
        latest = session.query(Kline).order_by(Kline.trade_time.desc()).first()
        data_age = (datetime.now() - datetime.fromisoformat(latest.trade_time.split()[0])).days

        return {
            "status": "healthy" if data_age < 3 else "degraded",
            "database": "connected",
            "latest_data_age_days": data_age,
            "code_version": "2026-01-19"  # æ›´æ–°æ—¶ä¿®æ”¹æ­¤ç‰ˆæœ¬å·
        }
    finally:
        session.close()
```

---

## ç›¸å…³æ–‡æ¡£

- [Kçº¿æ•°æ®æ–‡æ¡£](../kline_data.md)
- [å®æ—¶æ•°æ®æ–‡æ¡£](../realtime_data.md)
- [APScheduleré…ç½®](../../src/services/kline_scheduler.py)
- [æ•°æ®æ›´æ–°æ—¥å¿—](../../data/market.db â†’ data_update_logè¡¨)

---

## é—®é¢˜çŠ¶æ€

- âœ… **å·²è§£å†³**: äº¤æ˜“æ—¥å†ä¿®æ­£ã€åç«¯é‡å¯ã€Kçº¿æ•°æ®æ›´æ–°
- âœ… **å·²éªŒè¯**: å‰ç«¯æ˜¾ç¤ºæ­£å¸¸ã€APIæ­£å¸¸å“åº”
- ğŸ“‹ **å¾…å®Œæˆ**: æ·»åŠ æ•°æ®ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶

**ä¿®å¤æ—¶é—´**: 2026-01-19 12:00 - 12:15
**åœæœºæ—¶é—´**: çº¦3åˆ†é’Ÿï¼ˆé‡å¯åç«¯ï¼‰
**å½±å“ç”¨æˆ·**: æ— ï¼ˆä¿®å¤åœ¨äº¤æ˜“æ—¶é—´å†…å®Œæˆï¼Œå‰ç«¯æ•°æ®å·²æ¢å¤ï¼‰
