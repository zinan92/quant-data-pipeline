# K线形态智能识别系统 PRD

> 基于AI视觉能力的K线形态识别系统，替代传统规则算法

---

## 一、项目背景

### 1.1 传统形态识别的问题

传统的K线形态识别依赖严格的数学规则，例如：
- "双底两个低点差距不超过3%"
- "颈线突破需要放量50%以上"
- "头肩底左右肩高度差不超过5%"

**问题**：
1. **规则死板**：市场形态千变万化，3.2%和2.8%可能都是有效双底
2. **变种难穷举**：双底有标准型、不对称型、复合型等，规则无法覆盖
3. **缺乏上下文**：不考虑所处位置、市场环境、成交量配合
4. **参数敏感**：阈值稍微调整，识别结果大相径庭

### 1.2 AI识别的优势

- **模糊识别**：不需要精确符合，"大致像"就能识别
- **自适应**：不同股票、不同周期，自动适应
- **可解释**：能说明"为什么像双底"
- **综合判断**：形态 + 成交量 + 位置 + 趋势 综合考虑
- **零训练成本**：利用现有LLM/VLM能力，无需自己训练模型

---

## 二、技术方案

### 2.1 核心思路

**用视觉语言模型(VLM)看K线图，像交易员一样识别形态**

```
K线数据 → 生成K线图片 → VLM分析 → 输出形态识别结果
```

### 2.2 为什么选择图片识别而非数据识别

| 对比维度 | 数据识别 (OHLCV序列) | 图片识别 (K线截图) |
|---------|---------------------|-------------------|
| **直观性** | 需要复杂特征工程 | 跟人看图一样直观 |
| **形态变种** | 难以覆盖所有变种 | 自动识别变种 |
| **开发成本** | 每个形态都要写规则 | 用自然语言描述即可 |
| **可扩展性** | 新增形态需要开发 | 新增形态只需改Prompt |
| **准确性** | 依赖规则完备性 | 依赖VLM能力 |
| **可解释性** | 规则匹配结果 | AI给出分析理由 |

**结论**：图片识别更适合形态识别这种"看图说话"的任务

### 2.3 技术架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        形态识别系统                              │
└─────────────────────────────────────────────────────────────────┘

┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  K线数据     │ ──► │  图表生成    │ ──► │  K线图片    │
│  (OHLCV)    │     │ (ECharts/   │     │  (PNG)     │
│             │     │  matplotlib)│     │            │
└─────────────┘     └─────────────┘     └──────┬──────┘
                                               │
                                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                      VLM 视觉分析引擎                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  System Prompt: 形态识别专家人设 + 形态定义库              │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │  User Input: K线图片 + 分析请求                          │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │  Few-shot Examples: 典型形态示例图 (可选)                 │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                      Claude Vision / GPT-4V                     │
└──────────────────────────────┼──────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                        识别结果                                  │
│  {                                                              │
│    "patterns": [                                                │
│      {                                                          │
│        "name": "双底",                                          │
│        "confidence": 0.85,                                      │
│        "stage": "突破颈线确认中",                                │
│        "analysis": "两个低点接近，成交量配合良好...",            │
│        "suggestion": "可关注颈线突破后的回踩机会"                │
│      }                                                          │
│    ],                                                           │
│    "trend": "下跌趋势末期",                                     │
│    "support_resistance": [28.5, 32.0],                         │
│    "volume_analysis": "底部有温和放量迹象"                      │
│  }                                                              │
└─────────────────────────────────────────────────────────────────┘
```

### 2.4 VLM选型

| 模型 | 优势 | 劣势 | 推荐场景 |
|-----|------|------|---------|
| **Claude 3.5 Sonnet** | 视觉理解强、中文好、便宜 | - | ⭐ 首选 |
| **GPT-4V** | 视觉能力强 | 贵、中文一般 | 备选 |
| **Claude 3 Opus** | 最强推理能力 | 贵 | 复杂形态 |
| **Gemini Pro Vision** | 便宜 | 能力一般 | 成本敏感 |

**推荐**：使用 **Claude 3.5 Sonnet**，性价比最高

---

## 三、形态库定义

### 3.1 底部反转形态（重点识别）

#### 3.1.1 双底 (W底)

```yaml
名称: 双底 / W底 / Double Bottom
类型: 底部反转
可靠性: ⭐⭐⭐⭐

形态特征:
  - 两个明显的低点，价格接近（允许5-10%偏差）
  - 中间有一次反弹，形成颈线
  - 第二个低点通常伴随成交量萎缩
  - 突破颈线时成交量放大

变种:
  - 标准双底：两个低点几乎等高
  - 左高右低：第二个低点略低（更强信号）
  - 左低右高：第二个低点略高（需要更多确认）
  - 复合双底：底部有多个小低点

确认信号:
  - 放量突破颈线
  - 突破后回踩颈线不破
  - MACD金叉配合

目标位: 颈线 + (颈线 - 最低点)
```

#### 3.1.2 头肩底

```yaml
名称: 头肩底 / Inverse Head and Shoulders
类型: 底部反转
可靠性: ⭐⭐⭐⭐⭐

形态特征:
  - 三个低点：左肩、头部（最低）、右肩
  - 左右肩高度大致相当（允许10%偏差）
  - 头部明显低于两肩
  - 连接两肩反弹高点形成颈线

变种:
  - 标准头肩底：左右肩对称
  - 复合头肩底：头部或肩部有多个低点
  - 倾斜头肩底：颈线倾斜

确认信号:
  - 右肩成交量小于左肩和头部
  - 突破颈线放量
  - 突破后回踩颈线获得支撑

目标位: 颈线 + (颈线 - 头部最低点)
```

#### 3.1.3 圆弧底

```yaml
名称: 圆弧底 / Rounding Bottom / Saucer Bottom
类型: 底部反转
可靠性: ⭐⭐⭐⭐

形态特征:
  - 价格缓慢下跌，形成弧形底部
  - 底部没有尖锐的V形反转
  - 形成时间较长（通常数周到数月）
  - 成交量呈现"碗状"：两边大，中间小

变种:
  - 标准圆弧底：完美的U形
  - 带柄圆弧底：圆弧后有小幅回调

确认信号:
  - 右侧上涨时成交量逐步放大
  - 突破圆弧顶部压力位
  - 均线开始走平并拐头向上
```

#### 3.1.4 V形反转

```yaml
名称: V形反转 / V-Bottom
类型: 底部反转
可靠性: ⭐⭐⭐

形态特征:
  - 快速急跌后迅速反弹
  - 底部尖锐，停留时间极短
  - 下跌和上涨角度都很陡峭
  - 通常伴随重大消息或极端情绪

风险提示:
  - 容易形成假突破
  - 需要放量确认
  - 建议等回踩再介入
```

#### 3.1.5 三重底

```yaml
名称: 三重底 / Triple Bottom
类型: 底部反转
可靠性: ⭐⭐⭐⭐⭐

形态特征:
  - 三个低点价格接近
  - 比双底多一次确认，更可靠
  - 每次反弹的高点形成压力位
  - 突破压力位确认形态成立

确认信号:
  - 第三次触底成交量明显萎缩
  - 突破时成交量放大
```

### 3.2 顶部反转形态

#### 3.2.1 双顶 (M顶)

```yaml
名称: 双顶 / M顶 / Double Top
类型: 顶部反转
可靠性: ⭐⭐⭐⭐

形态特征:
  - 两个明显的高点，价格接近
  - 中间有一次回调，形成颈线
  - 第二个高点通常伴随成交量减少（量价背离）
  - 跌破颈线确认形态成立

确认信号:
  - 放量跌破颈线
  - 反弹无法收复颈线
```

#### 3.2.2 头肩顶

```yaml
名称: 头肩顶 / Head and Shoulders
类型: 顶部反转
可靠性: ⭐⭐⭐⭐⭐

形态特征:
  - 三个高点：左肩、头部（最高）、右肩
  - 左右肩高度大致相当
  - 头部明显高于两肩
  - 跌破颈线确认

确认信号:
  - 头部成交量小于左肩（量价背离）
  - 右肩成交量更小
  - 跌破颈线放量
```

### 3.3 中继形态

#### 3.3.1 上升旗形

```yaml
名称: 上升旗形 / Bull Flag
类型: 上涨中继
可靠性: ⭐⭐⭐⭐

形态特征:
  - 一波快速上涨形成"旗杆"
  - 随后小幅回调整理，形成向下倾斜的平行四边形"旗面"
  - 回调幅度通常不超过旗杆的38.2%-50%
  - 整理时成交量萎缩

确认信号:
  - 放量突破旗面上轨
  - 突破后目标位 = 旗杆高度
```

#### 3.3.2 杯柄形态

```yaml
名称: 杯柄形态 / Cup and Handle
类型: 上涨中继
可靠性: ⭐⭐⭐⭐⭐

形态特征:
  - 圆弧形的"杯身"
  - 杯身右侧上涨后小幅回调形成"杯柄"
  - 杯柄回调幅度通常在杯身深度的1/3以内
  - 杯柄倾斜向下

确认信号:
  - 放量突破杯柄高点
  - 目标位 = 杯身深度
```

#### 3.3.3 上升三角形

```yaml
名称: 上升三角形 / Ascending Triangle
类型: 上涨中继
可靠性: ⭐⭐⭐⭐

形态特征:
  - 高点在同一水平线（水平阻力）
  - 低点逐步抬高（上升支撑）
  - 形成向上收敛的三角形
  - 通常在上涨趋势中出现

确认信号:
  - 放量突破水平阻力
  - 突破后回踩阻力变支撑
```

#### 3.3.4 箱体突破

```yaml
名称: 箱体突破 / Rectangle Breakout
类型: 中继形态
可靠性: ⭐⭐⭐⭐

形态特征:
  - 价格在一定区间内横盘整理
  - 高点和低点形成明显的水平支撑压力
  - 整理时间越长，突破后空间越大
  - 成交量逐步萎缩

确认信号:
  - 放量突破箱体上轨
  - 突破幅度超过箱体高度的3%
```

### 3.4 趋势形态

#### 3.4.1 下降楔形

```yaml
名称: 下降楔形 / Falling Wedge
类型: 反转形态（通常看涨）
可靠性: ⭐⭐⭐⭐

形态特征:
  - 高点和低点都在下降
  - 但下降通道逐渐收窄
  - 两条趋势线向下倾斜并收敛
  - 通常出现在下跌趋势末期

确认信号:
  - 放量突破上轨
  - MACD底背离配合
```

#### 3.4.2 收敛三角形

```yaml
名称: 收敛三角形 / Symmetrical Triangle
类型: 中继形态
可靠性: ⭐⭐⭐

形态特征:
  - 高点逐步降低
  - 低点逐步抬高
  - 形成对称的三角形
  - 突破方向不确定，需要等待

确认信号:
  - 放量突破任一方向
  - 通常在三角形2/3处突破
```

### 3.5 技术指标形态

#### 3.5.1 MACD底背离

```yaml
名称: MACD底背离 / MACD Bullish Divergence
类型: 底部信号
可靠性: ⭐⭐⭐⭐⭐

形态特征:
  - 价格创新低
  - 但MACD指标（DIF或柱状）没有创新低
  - 形成价格与指标的背离

分级:
  - 一次背离：可靠性一般
  - 二次背离：可靠性高
  - 三次背离：可靠性很高

确认信号:
  - MACD金叉
  - 价格突破近期高点
```

#### 3.5.2 均线粘合突破

```yaml
名称: 均线粘合突破 / MA Convergence Breakout
类型: 起爆信号
可靠性: ⭐⭐⭐⭐

形态特征:
  - 多条均线（MA5/10/20/60）收敛粘合
  - 股价在均线附近窄幅整理
  - 成交量萎缩到极致
  - 突然放量突破

确认信号:
  - 均线开始多头发散
  - 成交量显著放大
  - 突破日收中阳或大阳
```

### 3.6 特殊起爆形态

#### 3.6.1 底部放量长阳

```yaml
名称: 底部放量长阳
类型: 起爆信号
可靠性: ⭐⭐⭐⭐

形态特征:
  - 股价处于相对低位（下跌50%以上或历史低位区）
  - 突然出现放量大阳线（涨幅5%以上）
  - 成交量是前期的2倍以上
  - 突破重要均线或压力位

风险提示:
  - 可能是主力出货
  - 需要后续确认
  - 建议等回踩再介入
```

#### 3.6.2 老鸭头

```yaml
名称: 老鸭头
类型: 上涨中继
可靠性: ⭐⭐⭐⭐

形态特征:
  - 一波上涨后回调（形成鸭头高点）
  - 回调时均线先发散后收敛
  - 在重要均线处获得支撑
  - 再次上涨突破前高（鸭嘴张开）

形象描述:
  - 鸭头高点：第一波上涨的高点
  - 鸭嘴：均线收敛后的回调低点
  - 鸭嘴张开：再次上涨突破

确认信号:
  - 回调不破MA60
  - 再次上涨时放量
  - 突破前高确认
```

#### 3.6.3 涨停突破

```yaml
名称: 涨停突破
类型: 强势信号
可靠性: ⭐⭐⭐⭐

形态特征:
  - 以涨停板方式突破重要压力位
  - 压力位可以是：前高、箱体上轨、长期均线
  - 成交量显著放大
  - 涨停封单量大

后续策略:
  - 次日高开可追
  - 回踩涨停价可买
  - 跌破涨停价止损
```

---

## 四、功能设计

### 4.1 核心功能

#### 4.1.1 单股形态识别

```
输入：股票代码 + 时间周期
输出：识别到的形态列表 + 分析报告

示例请求：
POST /api/pattern/analyze
{
  "ticker": "600519",
  "timeframe": "day",
  "limit": 120
}

示例响应：
{
  "ticker": "600519",
  "name": "贵州茅台",
  "timeframe": "day",
  "analysis_time": "2026-01-09T22:30:00",
  "patterns": [
    {
      "name": "双底",
      "name_en": "double_bottom",
      "confidence": 0.85,
      "stage": "颈线突破确认中",
      "position": {
        "left_bottom": {"date": "2025-12-15", "price": 1480},
        "right_bottom": {"date": "2026-01-05", "price": 1495},
        "neckline": 1580
      },
      "analysis": "两个低点1480和1495接近，相差约1%。中间反弹至1580形成颈线。当前价格1575接近颈线，若放量突破1580，双底形态确认。",
      "volume_note": "第二个低点成交量较第一个明显萎缩，符合双底特征",
      "suggestion": "关注1580颈线突破情况，突破后目标位约1680"
    }
  ],
  "trend_analysis": "中期下跌趋势，短期有企稳迹象",
  "support_levels": [1480, 1450],
  "resistance_levels": [1580, 1650],
  "overall_score": 72,
  "recommendation": "观望，等待颈线突破确认"
}
```

#### 4.1.2 批量形态扫描

```
输入：股票列表（或自选股） + 目标形态
输出：符合条件的股票列表

示例请求：
POST /api/pattern/scan
{
  "scope": "watchlist",  // 或 "all", "index:沪深300"
  "patterns": ["double_bottom", "head_shoulders_bottom", "macd_divergence"],
  "min_confidence": 0.7,
  "timeframe": "day"
}

示例响应：
{
  "scan_time": "2026-01-09T22:35:00",
  "total_scanned": 164,
  "matches": [
    {
      "ticker": "000858",
      "name": "五粮液",
      "pattern": "双底",
      "confidence": 0.88,
      "stage": "突破确认",
      "brief": "双底形态突破颈线，目标位180"
    },
    {
      "ticker": "002415",
      "name": "海康威视",
      "pattern": "MACD底背离",
      "confidence": 0.82,
      "stage": "金叉确认",
      "brief": "二次底背离后MACD金叉，关注30元压力"
    }
  ]
}
```

#### 4.1.3 形态监控告警

```
输入：监控条件设置
输出：当符合条件时推送告警

监控规则示例：
{
  "name": "自选股双底突破",
  "scope": "watchlist",
  "condition": {
    "pattern": "double_bottom",
    "stage": "breakout",  // 突破阶段
    "min_confidence": 0.8
  },
  "notify": ["app_push", "email"]
}
```

### 4.2 用户界面

#### 4.2.1 形态识别结果展示

```
┌────────────────────────────────────────────────────────────┐
│  贵州茅台 (600519)  形态分析                    日线 │ 周线  │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  ┌──────────────────────────────────────────────────────┐ │
│  │                                                      │ │
│  │              K线图 (标注形态位置)                    │ │
│  │                     ┌─┐                              │ │
│  │           ┌─┐      ┌┴─┴┐    颈线 1580 ────────      │ │
│  │    ┌─┐   ┌┴─┴┐    ┌┴───┴┐                          │ │
│  │   ┌┴─┴┐ ┌┴───┴┐  ┌┴─────┴┐                         │ │
│  │  ┌┴───┴┬┴─────┴┬─┴───────┴─┐   ← 双底形态           │ │
│  │  左底1480      右底1495                              │ │
│  │                                                      │ │
│  └──────────────────────────────────────────────────────┘ │
│                                                            │
│  ┌─ 识别结果 ────────────────────────────────────────────┐ │
│  │                                                        │ │
│  │  🎯 双底形态  置信度: 85%   阶段: 颈线突破确认中       │ │
│  │                                                        │ │
│  │  分析：                                                │ │
│  │  • 左底(12/15): ¥1,480                                │ │
│  │  • 右底(01/05): ¥1,495 (较左底高1%, 符合标准)         │ │
│  │  • 颈线位置: ¥1,580                                   │ │
│  │  • 当前价格: ¥1,575 (距颈线0.3%)                      │ │
│  │                                                        │ │
│  │  成交量分析：                                          │ │
│  │  • 右底成交量较左底萎缩35%, 符合双底特征              │ │
│  │                                                        │ │
│  │  操作建议：                                            │ │
│  │  • 若放量突破1580, 可考虑介入                         │ │
│  │  • 目标位: ¥1,680 (颈线+形态高度)                     │ │
│  │  • 止损位: ¥1,470 (跌破右底)                          │ │
│  │                                                        │ │
│  └────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────┘
```

#### 4.2.2 批量扫描结果页

```
┌────────────────────────────────────────────────────────────┐
│  形态扫描  自选股(164只)                      2026-01-09   │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  筛选: [双底] [头肩底] [MACD背离] [均线粘合]  置信度>70%  │
│                                                            │
│  找到 8 只股票符合条件                                     │
│                                                            │
│  ┌──────────────────────────────────────────────────────┐ │
│  │ 股票        形态          置信度   阶段      操作    │ │
│  ├──────────────────────────────────────────────────────┤ │
│  │ 五粮液      双底          88%     突破确认   查看 >  │ │
│  │ 海康威视    MACD底背离    82%     金叉确认   查看 >  │ │
│  │ 宁德时代    头肩底        79%     右肩形成   查看 >  │ │
│  │ 比亚迪      均线粘合      85%     即将突破   查看 >  │ │
│  │ ...                                                  │ │
│  └──────────────────────────────────────────────────────┘ │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

---

## 五、技术实现

### 5.1 K线图生成

使用 Python 生成标准化的K线图：

```python
# 图表生成要求
- 尺寸: 800x600 或 1200x800 (高清)
- 包含: K线主图 + 成交量副图 + MACD副图 (可选)
- 均线: MA5, MA10, MA20, MA60
- 标注: 最近的高低点价格
- 风格: 深色背景 (与前端一致)
- 格式: PNG
```

### 5.2 VLM Prompt 设计

```python
SYSTEM_PROMPT = """
你是一位专业的K线形态分析师，精通各类技术形态的识别。

你的任务是分析用户提供的K线图，识别其中的技术形态。

## 你需要识别的形态包括：

### 底部反转形态
- 双底(W底): 两个低点接近，突破颈线确认
- 头肩底: 左肩-头-右肩，头最低，突破颈线确认
- 圆弧底: 缓慢筑底的U形底部
- 三重底: 三个低点接近
- V形反转: 急跌后快速反弹

### 顶部反转形态
- 双顶(M顶): 两个高点接近
- 头肩顶: 左肩-头-右肩，头最高

### 中继形态
- 上升旗形: 上涨后向下倾斜的整理
- 上升三角形: 高点平齐，低点抬高
- 杯柄形态: 圆弧底+小幅回调
- 箱体整理: 水平区间震荡
- 下降楔形: 向下收敛的通道

### 技术指标形态
- MACD底背离: 价格新低但MACD不创新低
- MACD顶背离: 价格新高但MACD不创新高
- 均线粘合: 多条均线收敛

## 输出格式

请以JSON格式输出分析结果：

{
  "patterns": [
    {
      "name": "形态名称",
      "confidence": 0.85,  // 置信度 0-1
      "stage": "当前阶段",  // 如: 形成中/待突破/已确认
      "analysis": "详细分析说明",
      "key_points": {
        // 形态关键点位
      },
      "suggestion": "操作建议"
    }
  ],
  "trend": "整体趋势判断",
  "volume_analysis": "成交量分析",
  "support_resistance": {
    "support": [价位1, 价位2],
    "resistance": [价位1, 价位2]
  }
}

## 注意事项

1. 置信度要客观，不确定的形态置信度应该低
2. 识别形态要考虑:
   - 形态的完整性
   - 成交量的配合
   - 所处的趋势位置
   - 时间周期的影响
3. 如果没有明显形态，patterns数组可以为空
4. 提供可操作的建议，包括关键价位

## 关键分析原则 (从实战样本中学习)

### 原则 1: 先看底部结构，再看上方压力

**错误**: 看到上方有两个高点，就判断为"双顶压力"
**正确**: 先判断底部是否形成有效支撑结构，再评估上方压力

```
正确的分析顺序:
1. 底部是否形成有效支撑？(双底/头肩底/圆弧底)
2. 是否已经有效突破？(放量突破关键位)
3. 当前回调是趋势性下跌还是技术性回踩？
4. 最后才考虑上方压力位
```

> 📚 参考样本: [Sample 001 - 双底突破回踩](./pattern-samples/sample-001-analysis.md)

### 原则 2: 区分"双顶形成中"和"突破后回踩"

这两种形态在K线图上可能看起来相似，但含义完全相反：

| 特征 | 双顶形成中 (看空) | 突破后回踩 (看多) |
|-----|------------------|------------------|
| 底部结构 | 无有效底部支撑 | 已形成双底等底部形态 |
| 突破情况 | 未有效突破压力 | 已放量突破关键位 |
| 回调性质 | 趋势性下跌 | 技术性回踩确认 |
| 成交量 | 反弹缩量/下跌放量 | 突破放量/回踩缩量 |
| 均线状态 | 空头排列或纠缠 | 正在形成多头排列 |
| 操作建议 | 观望或减仓 (3-4分) | 买入机会 (8-9分) |

### 原则 3: "突破回踩起爆点"的识别要素

当底部形态突破后出现回调时，判断是否为买入机会：

```yaml
起爆点确认条件:
  ✅ 底部形态已确认: 双底/头肩底/圆弧底等已完成
  ✅ 已放量突破: 突破关键压力位时成交量明显放大
  ✅ 缩量回踩: 回调时成交量萎缩
  ✅ 支撑有效: 回踩不破重要支撑位(突破位/均线)
  ✅ 止跌信号: 出现小阳线/十字星等企稳信号

评分: 8-9分 (买入信号)
```

### 原则 4: 避免视角偏差

分析时容易犯的错误：
- ❌ 只看最近的高点，忽略底部结构
- ❌ 把技术性回踩误判为趋势反转
- ❌ 过度关注压力位，忽略支撑位的有效性
- ❌ 不考虑成交量的配合情况
"""

USER_PROMPT_TEMPLATE = """
请分析这张{stock_name}({ticker})的{timeframe}K线图，识别其中的技术形态。

当前价格: {current_price}
最近20日涨跌幅: {change_20d}%

请重点关注是否存在以下形态：
{target_patterns}
"""
```

### 5.3 API 设计

```python
# 路由: src/api/routes_pattern.py

@router.post("/analyze")
async def analyze_pattern(request: PatternAnalyzeRequest):
    """
    分析单只股票的K线形态

    1. 获取K线数据
    2. 生成K线图片
    3. 调用VLM分析
    4. 返回识别结果
    """
    pass

@router.post("/scan")
async def scan_patterns(request: PatternScanRequest):
    """
    批量扫描符合条件的股票

    1. 获取目标股票列表
    2. 并发分析每只股票
    3. 筛选符合条件的结果
    4. 按置信度排序返回
    """
    pass

@router.get("/definitions")
def get_pattern_definitions():
    """
    获取所有形态的定义说明
    """
    pass
```

### 5.4 成本估算

以 Claude 3.5 Sonnet 为例：

| 场景 | 图片数 | 输入Token | 输出Token | 单次成本 |
|-----|-------|----------|----------|---------|
| 单股分析 | 1张 | ~1500 | ~500 | ~$0.01 |
| 自选股扫描(164只) | 164张 | ~250K | ~80K | ~$1.5 |
| 全市场扫描(5450只) | 5450张 | ~8M | ~2.7M | ~$50 |

**成本控制策略**：
1. 先用规则预筛选，减少需要AI分析的数量
2. 缓存分析结果，避免重复分析
3. 批量扫描时使用较小的图片尺寸
4. 设置每日调用额度上限

---

## 六、开发计划

### 6.1 里程碑

| 阶段 | 内容 | 产出 |
|-----|------|------|
| **M1: 基础能力** | K线图生成 + VLM调用封装 | 能对单只股票进行形态分析 |
| **M2: 形态识别** | 实现核心形态识别 | 双底、头肩底、MACD背离 |
| **M3: 批量扫描** | 批量扫描 + 结果展示 | 自选股形态扫描功能 |
| **M4: 优化完善** | 准确率优化 + 更多形态 | 生产可用版本 |

### 6.2 任务分解

#### M1: 基础能力

- [ ] K线图生成模块
  - [ ] 使用 matplotlib/mplfinance 生成K线图
  - [ ] 包含均线、成交量、MACD
  - [ ] 支持标注关键价位
  - [ ] 输出为PNG图片

- [ ] VLM调用封装
  - [ ] Claude API 集成
  - [ ] Prompt模板管理
  - [ ] 响应解析
  - [ ] 错误处理和重试

- [ ] 基础API
  - [ ] POST /api/pattern/analyze 单股分析

#### M2: 形态识别

- [ ] 完善Prompt，提高识别准确率
- [ ] 添加few-shot示例图
- [ ] 测试和调优主要形态：
  - [ ] 双底
  - [ ] 头肩底
  - [ ] MACD底背离
  - [ ] 均线粘合突破

#### M3: 批量扫描

- [ ] POST /api/pattern/scan 批量扫描API
- [ ] 并发控制和限流
- [ ] 结果缓存
- [ ] 前端扫描结果页面

#### M4: 优化完善

- [ ] 更多形态支持
- [ ] 准确率统计和优化
- [ ] 形态监控告警
- [ ] 成本优化

---

## 七、风险与应对

### 7.1 技术风险

| 风险 | 影响 | 应对措施 |
|-----|------|---------|
| VLM识别准确率不够 | 误判形态 | 优化Prompt、添加few-shot、人工校验 |
| API调用成本高 | 预算超支 | 预筛选、缓存、限额 |
| 响应速度慢 | 用户体验差 | 异步处理、进度展示 |

### 7.2 业务风险

| 风险 | 影响 | 应对措施 |
|-----|------|---------|
| 形态识别导致投资损失 | 用户投诉 | 明确免责声明、强调仅供参考 |
| 过度依赖技术形态 | 投资决策偏差 | 结合基本面、提示风险 |

---

## 八、附录

### A. 参考资料

- 《日本蜡烛图技术》- Steve Nison
- 《技术分析》- Jack D. Schwager
- TradingView 形态识别文档

### B. 形态示例图

(后续补充各形态的标准示例图)

---

**文档版本**: v1.0
**创建日期**: 2026-01-09
**最后更新**: 2026-01-09
