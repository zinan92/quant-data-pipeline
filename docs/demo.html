<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¿å—ç›‘æ§ - Demo</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #0f1117;
      color: #ffffff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding: 20px;
    }

    .container {
      max-width: 1800px;
      margin: 0 auto;
    }

    .concept-table {
      background: #1a1d2e;
      border-radius: 4px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #2d2f3e;
    }

    .table-header h3 {
      color: #ffffff;
      font-size: 16px;
      font-weight: 500;
    }

    .update-time {
      color: #8c8c8c;
      font-size: 12px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead {
      background: #252835;
    }

    thead th {
      color: #8c8c8c;
      font-weight: 400;
      padding: 10px 8px;
      border-bottom: 1px solid #2d2f3e;
      white-space: nowrap;
      font-size: 12px;
    }

    tbody tr {
      border-bottom: 1px solid #2d2f3e;
      transition: background 0.2s;
    }

    tbody tr:hover {
      background: #252835;
    }

    tbody td {
      padding: 10px 8px;
      color: #ffffff;
    }

    td.center {
      text-align: center;
    }

    td.right {
      text-align: right;
      font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
    }

    td.name {
      color: #40a9ff;
      cursor: pointer;
      font-weight: 500;
    }

    td.name:hover {
      text-decoration: underline;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #8c8c8c;
    }

    .error {
      text-align: center;
      padding: 40px;
      color: #ff4d4f;
    }

    .red {
      color: #ff4d4f;
    }

    .green {
      color: #52c41a;
    }

    .status-bar {
      background: #1a1d2e;
      padding: 12px 16px;
      border-radius: 4px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #52c41a;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .refresh-btn {
      background: #40a9ff;
      color: white;
      border: none;
      padding: 6px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s;
    }

    .refresh-btn:hover {
      background: #096dd9;
    }

    .refresh-btn:disabled {
      background: #434343;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="status-bar">
      <div class="status-indicator">
        <div class="status-dot"></div>
        <span id="status-text">æ­£åœ¨è¿æ¥...</span>
      </div>
      <button class="refresh-btn" onclick="refreshAll()">æ‰‹åŠ¨åˆ·æ–°</button>
    </div>

    <!-- æ¶¨å¹…å‰20æ¦‚å¿µ -->
    <div class="concept-table">
      <div class="table-header">
        <h3>ğŸ“ˆ æ¶¨å¹…å‰20æ¦‚å¿µæ¿å—</h3>
        <span class="update-time" id="update-time-top">-</span>
      </div>
      <div id="table-top"></div>
    </div>

    <!-- è‡ªé€‰çƒ­é—¨æ¦‚å¿µ -->
    <div class="concept-table">
      <div class="table-header">
        <h3>â­ è‡ªé€‰çƒ­é—¨æ¦‚å¿µ</h3>
        <span class="update-time" id="update-time-watch">-</span>
      </div>
      <div id="table-watch"></div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:5000';

    // æ ¼å¼åŒ–æ•°å­—
    function formatNumber(value, type) {
      if (value === 0 || value === null || value === undefined) return '-';

      switch (type) {
        case 'percent':
          return `${value > 0 ? '+' : ''}${value.toFixed(2)}%`;
        case 'money':
          return `${value.toFixed(2)}äº¿`;
        case 'volume':
          return `${value.toFixed(2)}ä¸‡`;
        case 'ratio':
          return value.toFixed(2);
        default:
          return value.toFixed(2);
      }
    }

    // è·å–é¢œè‰²
    function getColor(value) {
      if (value > 0) return 'red';
      if (value < 0) return 'green';
      return '';
    }

    // æ¸²æŸ“è¡¨æ ¼
    function renderTable(data, containerId, updateTimeId) {
      const container = document.getElementById(containerId);

      if (!data || data.length === 0) {
        container.innerHTML = '<div class="loading">æš‚æ— æ•°æ®</div>';
        return;
      }

      let html = `
        <table>
          <thead>
            <tr>
              <th>æ’å</th>
              <th>åç§°</th>
              <th>æ¶¨å¹…%</th>
              <th>æ¶¨é€Ÿ</th>
              <th>ä¸»åŠ›å‡€é‡</th>
              <th>ä¸»åŠ›å‡€æµå…¥</th>
              <th>é‡æ¯”</th>
              <th>æ¶¨å®¶æ•°</th>
              <th>è·Œå®¶æ•°</th>
              <th>æ¶¨åœæ•°</th>
              <th>5æ—¥æ¶¨å¹…</th>
              <th>10æ—¥æ¶¨å¹…</th>
              <th>20æ—¥æ¶¨å¹…</th>
              <th>æ€»é‡</th>
              <th>æ€»é‡‘é¢</th>
            </tr>
          </thead>
          <tbody>
      `;

      data.forEach(row => {
        html += `
          <tr>
            <td class="center">${row.rank}</td>
            <td class="name">${row.name}</td>
            <td class="right ${getColor(row.changePct)}">${formatNumber(row.changePct, 'percent')}</td>
            <td class="right ${getColor(row.changeValue)}">${formatNumber(row.changeValue, 'number')}</td>
            <td class="right ${getColor(row.mainVolume)}">${formatNumber(row.mainVolume, 'number')}</td>
            <td class="right ${getColor(row.moneyInflow)}">${formatNumber(row.moneyInflow, 'money')}</td>
            <td class="right">${formatNumber(row.volumeRatio, 'ratio')}</td>
            <td class="center red">${row.upCount}</td>
            <td class="center green">${row.downCount}</td>
            <td class="center red" style="font-weight: bold">${row.limitUp}</td>
            <td class="right ${getColor(row.day5Change)}">${formatNumber(row.day5Change, 'percent')}</td>
            <td class="right ${getColor(row.day10Change)}">${formatNumber(row.day10Change, 'percent')}</td>
            <td class="right ${getColor(row.day20Change)}">${formatNumber(row.day20Change, 'percent')}</td>
            <td class="right">${formatNumber(row.volume, 'volume')}</td>
            <td class="right">${formatNumber(row.turnover, 'money')}</td>
          </tr>
        `;
      });

      html += `
          </tbody>
        </table>
      `;

      container.innerHTML = html;
    }

    // è·å–æ•°æ®
    async function fetchData(type) {
      try {
        const url = type === 'top'
          ? `${API_BASE}/api/concepts/top?n=20`
          : `${API_BASE}/api/concepts/watch`;

        const response = await fetch(url);
        const result = await response.json();

        if (result.success) {
          const containerId = type === 'top' ? 'table-top' : 'table-watch';
          const updateTimeId = type === 'top' ? 'update-time-top' : 'update-time-watch';

          renderTable(result.data, containerId, updateTimeId);
          document.getElementById(updateTimeId).textContent = `æ›´æ–°æ—¶é—´: ${result.timestamp}`;

          // æ›´æ–°çŠ¶æ€
          document.getElementById('status-text').textContent = 'å®æ—¶ç›‘æ§ä¸­';
        }
      } catch (error) {
        console.error('è·å–æ•°æ®å¤±è´¥:', error);
        const containerId = type === 'top' ? 'table-top' : 'table-watch';
        document.getElementById(containerId).innerHTML =
          '<div class="error">âŒ è¿æ¥å¤±è´¥ï¼Œè¯·ç¡®ä¿APIæœåŠ¡å·²å¯åŠ¨</div>';

        document.getElementById('status-text').textContent = 'è¿æ¥å¤±è´¥';
      }
    }

    // åˆ·æ–°æ‰€æœ‰æ•°æ®
    async function refreshAll() {
      const btn = document.querySelector('.refresh-btn');
      btn.disabled = true;
      btn.textContent = 'åˆ·æ–°ä¸­...';

      await Promise.all([
        fetchData('top'),
        fetchData('watch')
      ]);

      btn.disabled = false;
      btn.textContent = 'æ‰‹åŠ¨åˆ·æ–°';
    }

    // åˆå§‹åŒ–
    async function init() {
      await refreshAll();

      // æ¯2.5åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°
      setInterval(refreshAll, 150000);
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
