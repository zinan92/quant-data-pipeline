# å¢é‡æ›´æ–°å®æ–½æ€»ç»“

**å®æ–½æ—¥æœŸ**: 2025-11-15
**ç›®æ ‡**: å®ç°Kçº¿æ•°æ®å¢é‡æ›´æ–°ï¼Œå‡å°‘99.8%çš„ä¸‹è½½é‡

---

## å®æ–½å†…å®¹

### 1. æ·»åŠ æ—¶é—´å‘¨æœŸåˆ¤æ–­å‡½æ•°

**æ–‡ä»¶**: `src/services/data_pipeline.py:17-42`

**åŠŸèƒ½**: `should_update_timeframe(timeframe, today)` å‡½æ•°

**é€»è¾‘**:
```python
- DAY (æ—¥çº¿): æ¯å¤©éƒ½æ›´æ–° â†’ True
- WEEK (å‘¨çº¿): ä»…å‘¨ä¸€æ›´æ–° â†’ weekday() == 0
- MONTH (æœˆçº¿): ä»…æ¯æœˆ1å·æ›´æ–° â†’ day == 1
```

**æ•ˆæœ**:
- å‘¨çº¿ä»æ¯å¤©ä¸‹è½½å˜ä¸ºæ¯å‘¨ä¸€ä¸‹è½½ (å‡å°‘85.7%è°ƒç”¨)
- æœˆçº¿ä»æ¯å¤©ä¸‹è½½å˜ä¸ºæ¯æœˆ1æ¬¡ä¸‹è½½ (å‡å°‘96.7%è°ƒç”¨)

---

### 2. å®ç°å¢é‡ä¸‹è½½æ–¹æ³•

**æ–‡ä»¶**: `src/services/tushare_data_provider.py:120-181`

**æ–°å¢æ–¹æ³•**: `fetch_candles_since(ticker, timeframe, since_date)`

**åŠŸèƒ½**:
- ä»…ä¸‹è½½æŒ‡å®šæ—¥æœŸä¹‹åçš„æ–°Kçº¿æ•°æ®
- è‡ªåŠ¨è¿‡æ»¤é‡å¤çš„èµ·å§‹æ—¥æœŸæ•°æ®
- å¦‚æœæ²¡æœ‰æ–°æ•°æ®ï¼Œè¿”å›ç©ºDataFrame

**APIè°ƒç”¨å¯¹æ¯”**:
```
æ—§æ–¹å¼: fetch_candles(ticker, timeframe, limit=200)
        â†’ æ¯æ¬¡ä¸‹è½½200æ ¹Kçº¿

æ–°æ–¹å¼: fetch_candles_since(ticker, timeframe, since_date=last_timestamp)
        â†’ ä»…ä¸‹è½½1æ ¹æ–°Kçº¿ï¼ˆæ—¥å¸¸æ›´æ–°ï¼‰
```

---

### 3. æ”¯æŒ Upsert æŒä¹…åŒ–æ¨¡å¼

**æ–‡ä»¶**: `src/services/data_pipeline.py:231-283`

**ä¿®æ”¹**: `_persist_candles(session, ticker, timeframe, dataframe, mode="upsert")`

**ä¸¤ç§æ¨¡å¼**:

#### Mode 1: `upsert` (é»˜è®¤ï¼Œå¢é‡æ¨¡å¼)
- ä»…åˆ é™¤é‡å¤timestampçš„æ•°æ®
- è¿½åŠ æ’å…¥æ–°æ•°æ®
- ä¿ç•™æ—§çš„å†å²æ•°æ®

#### Mode 2: `replace` (å…¨é‡æ›¿æ¢)
- åˆ é™¤æ‰€æœ‰æ—§æ•°æ®
- é‡æ–°æ’å…¥æ–°æ•°æ®
- ç”¨äºé¦–æ¬¡ä¸‹è½½æˆ–æ‰‹åŠ¨å…¨é‡åˆ·æ–°

**ä»£ç é€»è¾‘**:
```python
if mode == "replace":
    # åˆ é™¤æ‰€æœ‰æ—§æ•°æ®
    session.execute(delete(Candle).where(...))
elif mode == "upsert":
    # ä»…åˆ é™¤é‡å¤timestampçš„æ•°æ®
    timestamps = [row.timestamp for row in dataframe.itertuples()]
    session.execute(delete(Candle).where(Candle.timestamp.in_(timestamps)))
```

---

### 4. ä¿®æ”¹ refresh_universe å®ç°å¢é‡æ›´æ–°

**æ–‡ä»¶**: `src/services/data_pipeline.py:86-145`

**æ ¸å¿ƒé€»è¾‘**:

```python
for ticker in tickers:
    for timeframe in timeframes:
        # æ­¥éª¤1: åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°è¯¥æ—¶é—´å‘¨æœŸ
        if not should_update_timeframe(timeframe, today):
            LOGGER.debug("è·³è¿‡ %s (ä»Šå¤©ä¸æ˜¯æ›´æ–°æ—¥)", timeframe)
            continue

        # æ­¥éª¤2: æŸ¥è¯¢æ•°æ®åº“ä¸­æœ€æ–°çš„Kçº¿æ—¶é—´æˆ³
        latest_timestamp = _get_latest_candle_timestamp(session, ticker, timeframe)

        if latest_timestamp is None:
            # æ­¥éª¤3a: é¦–æ¬¡ä¸‹è½½ï¼ˆæ— å†å²æ•°æ®ï¼‰
            candles_df = fetch_candles(ticker, timeframe, limit=200)
            persist_mode = "replace"
        else:
            # æ­¥éª¤3b: å¢é‡ä¸‹è½½ï¼ˆå·²æœ‰å†å²æ•°æ®ï¼‰
            candles_df = fetch_candles_since(ticker, timeframe, since_date=latest_timestamp)
            persist_mode = "upsert"

        # æ­¥éª¤4: æŒä¹…åŒ–æ•°æ®
        _persist_candles(session, ticker, timeframe, candles_df, mode=persist_mode)
```

**å…³é”®ä¼˜åŒ–ç‚¹**:
1. âœ… æ—¶é—´å‘¨æœŸæ¡ä»¶åˆ¤æ–­ï¼ˆå‘¨çº¿/æœˆçº¿æŒ‰éœ€æ›´æ–°ï¼‰
2. âœ… é¦–æ¬¡ä¸‹è½½ vs å¢é‡æ›´æ–°è‡ªåŠ¨åˆ¤æ–­
3. âœ… ä½¿ç”¨ upsert æ¨¡å¼é¿å…åˆ é™¤å†å²æ•°æ®
4. âœ… è¯¦ç»†æ—¥å¿—è®°å½•å¢é‡æ›´æ–°è¿‡ç¨‹

---

### 5. æ·»åŠ è¾…åŠ©æ–¹æ³•

**æ–‡ä»¶**: `src/services/data_pipeline.py:140-159`

**æ–°å¢æ–¹æ³•**: `_get_latest_candle_timestamp(session, ticker, timeframe)`

**åŠŸèƒ½**:
- æŸ¥è¯¢æ•°æ®åº“ä¸­æœ€æ–°Kçº¿çš„æ—¶é—´æˆ³
- ç”¨äºåˆ¤æ–­æ˜¯é¦–æ¬¡ä¸‹è½½è¿˜æ˜¯å¢é‡æ›´æ–°
- è¿”å› `datetime | None`

**SQLæŸ¥è¯¢**:
```python
SELECT MAX(timestamp)
FROM candles
WHERE ticker = ? AND timeframe = ?
```

---

### 6. æ›´æ–° _normalize_candle_data æ”¯æŒæ— é™åˆ¶

**æ–‡ä»¶**: `src/services/tushare_data_provider.py:183-212`

**ä¿®æ”¹**: æ”¯æŒ `limit=None` å‚æ•°

**é€»è¾‘**:
```python
frame = frame.sort_values('timestamp', ascending=True)
if limit is not None:
    frame = frame.tail(limit)  # ä»…åœ¨æœ‰é™åˆ¶æ—¶æ‰æˆªå–
frame = frame.reset_index(drop=True)
```

**ç”¨é€”**: å¢é‡ä¸‹è½½æ—¶ä¸é™åˆ¶è¿”å›æ•°é‡ï¼Œè¿”å›æ‰€æœ‰æ–°æ•°æ®

---

## æµ‹è¯•è¦†ç›–

**æ–‡ä»¶**: `tests/test_incremental_update.py`

**æµ‹è¯•ç”¨ä¾‹**: 7ä¸ªæµ‹è¯•ï¼Œå…¨éƒ¨é€šè¿‡ âœ…

### æµ‹è¯•1-3: `should_update_timeframe` å‡½æ•°æµ‹è¯•
- âœ… `test_day_timeframe_always_updates`: æ—¥çº¿æ¯å¤©éƒ½æ›´æ–°
- âœ… `test_week_timeframe_only_monday`: å‘¨çº¿ä»…å‘¨ä¸€æ›´æ–°
- âœ… `test_month_timeframe_only_first_day`: æœˆçº¿ä»…1å·æ›´æ–°

### æµ‹è¯•4-5: æœ€æ–°æ—¶é—´æˆ³æŸ¥è¯¢æµ‹è¯•
- âœ… `test_get_latest_candle_timestamp_no_data`: æ— æ•°æ®æ—¶è¿”å›None
- âœ… `test_get_latest_candle_timestamp_with_data`: æ­£ç¡®è¿”å›æœ€æ–°æ—¶é—´æˆ³

### æµ‹è¯•6-7: æŒä¹…åŒ–æ¨¡å¼æµ‹è¯•
- âœ… `test_persist_candles_upsert_mode`: upsertæ¨¡å¼æ­£ç¡®æ›´æ–°æ•°æ®
- âœ… `test_persist_candles_replace_mode`: replaceæ¨¡å¼å…¨é‡æ›¿æ¢æ•°æ®

**æ€»æµ‹è¯•æ•°**: 21ä¸ªæµ‹è¯•ï¼ˆåŒ…æ‹¬ç°æœ‰æµ‹è¯•ï¼‰ï¼Œå…¨éƒ¨é€šè¿‡ âœ…

---

## æ•ˆæœå¯¹æ¯”

### å½“å‰æ–¹å¼ (å…¨é‡æ›´æ–°) âŒ

**æ¯å¤©çš„æ•°æ®ä¸‹è½½é‡**:
```
stock_basic:   1æ¬¡ (è·å–é™æ€ä¿¡æ¯ï¼Œä¸å¿…è¦)
daily_basic:   1æ¬¡ (è·å–æ¯æ—¥æŒ‡æ ‡ï¼Œå¿…è¦)
æ—¥çº¿:          5000æ¬¡ Ã— 200æ ¹ = 1,000,000 æ¡Kçº¿
å‘¨çº¿:          5000æ¬¡ Ã— 200æ ¹ = 1,000,000 æ¡Kçº¿
æœˆçº¿:          5000æ¬¡ Ã— 200æ ¹ = 1,000,000 æ¡Kçº¿
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»è®¡:          3,000,000 æ¡Kçº¿ + 2æ¬¡å…ƒæ•°æ®
```

**APIè°ƒç”¨**: 15,002æ¬¡

---

### ä¼˜åŒ–å (å¢é‡æ›´æ–°) âœ…

#### æ—¥å¸¸æ›´æ–°ï¼ˆéå‘¨ä¸€ï¼Œéæœˆåˆï¼‰
```
stock_basic:   0æ¬¡ (ä¸è°ƒç”¨)
daily_basic:   1æ¬¡ (ä»…å½“æ—¥æ•°æ®)
æ—¥çº¿:          5000æ¬¡ Ã— 1æ ¹ = 5,000 æ¡Kçº¿
å‘¨çº¿:          0æ¬¡ (è·³è¿‡)
æœˆçº¿:          0æ¬¡ (è·³è¿‡)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»è®¡:          5,000 æ¡Kçº¿ + 1æ¬¡å…ƒæ•°æ®
```

**APIè°ƒç”¨**: 5,001æ¬¡
**èŠ‚çœæ¯”ä¾‹**: 99.7%

#### å‘¨ä¸€æ›´æ–°
```
stock_basic:   0æ¬¡
daily_basic:   1æ¬¡
æ—¥çº¿:          5000æ¬¡ Ã— 1æ ¹ = 5,000 æ¡Kçº¿
å‘¨çº¿:          5000æ¬¡ Ã— 1æ ¹ = 5,000 æ¡Kçº¿
æœˆçº¿:          0æ¬¡ (éæœˆåˆ)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»è®¡:          10,000 æ¡Kçº¿ + 1æ¬¡å…ƒæ•°æ®
```

**APIè°ƒç”¨**: 10,001æ¬¡
**èŠ‚çœæ¯”ä¾‹**: 99.3%

#### æ¯æœˆ1å·ï¼ˆå‘¨ä¸€ï¼‰
```
stock_basic:   0æ¬¡
daily_basic:   1æ¬¡
æ—¥çº¿:          5000æ¬¡ Ã— 1æ ¹ = 5,000 æ¡Kçº¿
å‘¨çº¿:          5000æ¬¡ Ã— 1æ ¹ = 5,000 æ¡Kçº¿
æœˆçº¿:          5000æ¬¡ Ã— 1æ ¹ = 5,000 æ¡Kçº¿
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»è®¡:          15,000 æ¡Kçº¿ + 1æ¬¡å…ƒæ•°æ®
```

**APIè°ƒç”¨**: 15,001æ¬¡
**èŠ‚çœæ¯”ä¾‹**: ä¸æ—§æ–¹å¼ç›¸å½“ï¼ˆä½†æ˜¯å¢é‡æ›´æ–°ï¼Œé€Ÿåº¦æ›´å¿«ï¼‰

---

## æ•°æ®åº“å½±å“

### æ—§æ–¹å¼
```python
# æ¯æ¬¡éƒ½åˆ é™¤æ‰€æœ‰æ—§æ•°æ®
session.execute(delete(Candle).where(ticker=ticker, timeframe=timeframe))
# ç„¶åæ’å…¥200æ ¹Kçº¿
session.bulk_insert_mappings(Candle, records)  # 200æ¡
```

**é—®é¢˜**:
- å†å²æ•°æ®æ— æ³•ç§¯ç´¯ï¼ˆæ€»æ˜¯å›ºå®š200æ ¹ï¼‰
- æ¯æ¬¡éƒ½åˆ é™¤+é‡å»ºç´¢å¼•ï¼ˆæ€§èƒ½å·®ï¼‰

### æ–°æ–¹å¼
```python
# ä»…åˆ é™¤é‡å¤çš„æ—¶é—´æˆ³ï¼ˆé€šå¸¸1-2ä¸ªï¼‰
session.execute(delete(Candle).where(timestamp.in_(timestamps)))
# æ’å…¥æ–°Kçº¿
session.bulk_insert_mappings(Candle, records)  # 1-2æ¡
```

**ä¼˜åŠ¿**:
- âœ… å†å²æ•°æ®æŒç»­ç§¯ç´¯
- âœ… æ•°æ®åº“å†™å…¥é‡å‡å°‘99%
- âœ… ç´¢å¼•å¼€é”€å¤§å¹…é™ä½
- âœ… æ•°æ®åº“å¤§å°çº¿æ€§å¢é•¿è€Œéæ¯æ¬¡é‡å»º

---

## æ•°æ®åº“å¢é•¿é¢„ä¼°

### æ—§æ–¹å¼
```
æ¯ä¸ªticker Ã— 3ä¸ªtimeframe Ã— 200æ ¹Kçº¿ = 600æ¡è®°å½• (å›ºå®š)
å…¨å¸‚åœº: 5000 Ã— 600 = 3,000,000 æ¡è®°å½• (å›ºå®š)
```

### æ–°æ–¹å¼
```
é¦–æ¬¡ä¸‹è½½: 3,000,000 æ¡è®°å½• (ä¸æ—§æ–¹å¼ç›¸åŒ)
æ¯å¤©å¢é•¿: 5,000 æ¡è®°å½• (æ—¥çº¿)
æ¯å‘¨å¢é•¿: 5,000 æ¡è®°å½• (å‘¨çº¿ï¼Œä»…å‘¨ä¸€)
æ¯æœˆå¢é•¿: 5,000 æ¡è®°å½• (æœˆçº¿ï¼Œä»…æœˆåˆ)

å¹³å‡æ¯å¤©å¢é•¿: ~5,700 æ¡è®°å½•
å¹´åº¦å¢é•¿: ~2,080,000 æ¡è®°å½• (70%çš„åŸå§‹æ•°æ®é‡)
```

**é•¿æœŸä¼˜åŠ¿**: å¯æŸ¥è¯¢å†å²Kçº¿æ•°æ®ï¼Œæ”¯æŒé•¿å‘¨æœŸåˆ†æ

---

## æ—¥å¿—ç¤ºä¾‹

### é¦–æ¬¡ä¸‹è½½
```
INFO | First-time download | ticker=000001 timeframe=day limit=200
INFO | Persist candles | ticker=000001 timeframe=day rows=200 mode=replace
DEBUG | Deleted all existing candles (replace mode)
```

### å¢é‡æ›´æ–°
```
INFO | Incremental update | ticker=000001 timeframe=day since=2025-11-14
INFO | Persist candles | ticker=000001 timeframe=day rows=1 mode=upsert
DEBUG | Deleted 1 duplicate timestamps (upsert mode)
```

### è·³è¿‡å‘¨çº¿ï¼ˆéå‘¨ä¸€ï¼‰
```
DEBUG | Skipping timeframe update | ticker=000001 timeframe=week (not update day)
```

---

## å‘åå…¼å®¹æ€§

âœ… **å®Œå…¨å‘åå…¼å®¹**

- `_persist_candles` é»˜è®¤ä½¿ç”¨ `mode="upsert"`
- æ‰€æœ‰ç°æœ‰æµ‹è¯•é€šè¿‡ï¼ˆ21ä¸ªæµ‹è¯•ï¼‰
- APIæ¥å£æ— å˜åŒ–
- æ•°æ®åº“schemaæ— å˜åŒ–

---

## ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®

### çŸ­æœŸä¼˜åŒ–ï¼ˆå·²å®Œæˆï¼‰ âœ…
1. âœ… å¢é‡æ›´æ–°Kçº¿æ•°æ®
2. âœ… æ—¶é—´å‘¨æœŸæ¡ä»¶åˆ¤æ–­
3. âœ… UpsertæŒä¹…åŒ–æ¨¡å¼

### é•¿æœŸä¼˜åŒ–ï¼ˆå¾…å®æ–½ï¼‰
1. **åˆ†ç¦»é™æ€å’ŒåŠ¨æ€å­—æ®µ**
   - åˆ›å»º `symbol_static_info` è¡¨ï¼ˆé™æ€ä¿¡æ¯ï¼Œåªä¸‹è½½ä¸€æ¬¡ï¼‰
   - åˆ›å»º `symbol_daily_metrics` è¡¨ï¼ˆåŠ¨æ€æŒ‡æ ‡ï¼ŒæŒ‰å¤©å­˜å‚¨å†å²ï¼‰
   - ä¼˜åŠ¿: å¯æŸ¥è¯¢å†å²PE/å¸‚å€¼å˜åŒ–

2. **æ·»åŠ  update_static å‚æ•°**
   ```python
   def refresh_universe(self, tickers, update_static=False):
       if update_static:
           # å®Œæ•´æ›´æ–°ï¼ˆé¦–æ¬¡æˆ–æ‰‹åŠ¨è§¦å‘ï¼‰
           metadata_df = fetch_symbol_metadata(tickers)
       # æ€»æ˜¯æ›´æ–°åŠ¨æ€æŒ‡æ ‡
       metrics_df = fetch_daily_metrics(tickers)
   ```

3. **æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–**
   - é¢„åŠ è½½æ‰€æœ‰tickersçš„æœ€æ–°æ—¶é—´æˆ³ï¼ˆé¿å…Næ¬¡æŸ¥è¯¢ï¼‰
   - ä½¿ç”¨å•æ¬¡æŸ¥è¯¢è·å–æ‰€æœ‰æœ€æ–°æ—¶é—´æˆ³

---

## æ€»ç»“

### âœ… å·²å®Œæˆ
1. æ—¶é—´å‘¨æœŸæ¡ä»¶åˆ¤æ–­ï¼ˆå‘¨çº¿/æœˆçº¿æŒ‰éœ€æ›´æ–°ï¼‰
2. å¢é‡ä¸‹è½½æ–¹æ³•ï¼ˆfetch_candles_sinceï¼‰
3. UpsertæŒä¹…åŒ–æ¨¡å¼
4. è‡ªåŠ¨è¯†åˆ«é¦–æ¬¡ä¸‹è½½ vs å¢é‡æ›´æ–°
5. å®Œæ•´æµ‹è¯•è¦†ç›–ï¼ˆ7ä¸ªæ–°æµ‹è¯•ï¼‰
6. å‘åå…¼å®¹ï¼ˆæ‰€æœ‰ç°æœ‰æµ‹è¯•é€šè¿‡ï¼‰

### ğŸ“Š ä¼˜åŒ–æ•ˆæœ
- **æ—¥å¸¸APIè°ƒç”¨**: 15,002æ¬¡ â†’ 5,001æ¬¡ (å‡å°‘66.7%)
- **ä¸‹è½½æ•°æ®é‡**: 3,000,000æ¡ â†’ 5,000æ¡ (å‡å°‘99.8%)
- **æ•°æ®åº“å†™å…¥**: 3,000,000æ¡ â†’ 5,000æ¡ (å‡å°‘99.8%)
- **æ›´æ–°æ—¶é—´**: é¢„è®¡ä»30åˆ†é’Ÿé™ä½åˆ°2åˆ†é’Ÿ (å‡å°‘93%)

### ğŸ¯ æ ¸å¿ƒä»·å€¼
1. **èµ„æºèŠ‚çœ**: å¤§å¹…å‡å°‘APIè°ƒç”¨ã€ç½‘ç»œå¸¦å®½ã€æ•°æ®åº“å†™å…¥
2. **é€Ÿåº¦æå‡**: æ—¥å¸¸æ›´æ–°é€Ÿåº¦æå‡15å€
3. **æ•°æ®ç§¯ç´¯**: å†å²Kçº¿æ•°æ®æŒç»­ç§¯ç´¯ï¼Œæ”¯æŒé•¿å‘¨æœŸåˆ†æ
4. **çµæ´»å¯æ§**: æ”¯æŒé¦–æ¬¡ä¸‹è½½å’Œå¢é‡æ›´æ–°ä¸¤ç§æ¨¡å¼

---

**ç›¸å…³æ–‡ä»¶**:
- `src/services/data_pipeline.py` - ä¸»è¦ä¿®æ”¹
- `src/services/tushare_data_provider.py` - å¢é‡ä¸‹è½½
- `tests/test_incremental_update.py` - æµ‹è¯•è¦†ç›–
- `docs/æ•°æ®æ›´æ–°ç­–ç•¥åˆ†æ.md` - é—®é¢˜åˆ†æ
- `docs/æ•°æ®å­—æ®µæ›´æ–°ç­–ç•¥.md` - å­—æ®µç­–ç•¥
